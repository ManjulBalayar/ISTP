<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Data Visualization</title>
    <!-- Include any necessary CSS or JS files -->
    <style>
        #qol_data_type_container {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Quality of Life Data Visualization</h1>

    <!-- Single Form for Selecting Options and Submitting Data -->
    <form id="selection-form" action="{% url 'query_data' %}" method="get">
        <!-- Dropdown for Selecting Town -->
        <label for="town">Select Town:</label>
        <select name="town" id="town">
            <option value="">Select a town</option>
            {% for town in towns %}
                <option value="{{ town }}">{{ town }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown for Selecting Type of Data -->
        <label for="data_type">Select Type of Data:</label>
        <select name="data_type" id="data_type">
            <option value="">Select a data type</option>
            <option value="qol">Quality of Life</option>
            <option value="other">Other datas...</option>
        </select>

        <!-- Dropdown for Selecting Demographic -->
        <label for="demographic">Select Demographic:</label>
        <select name="demographic" id="demographic">
            <option value="">Select a demographic</option>
            {% for demo in demographics %}
                <option value="{{ demo }}">{{ demo }}</option>
            {% endfor %}
        </select>

        <!-- Dropdown for Selecting Specific Demographic -->
        <label for="specific_demographic">Select Specific Demographic:</label>
        <select name="specific_demographic" id="specific_demographic">
            <option value="">Select a specific demographic</option>
            <!-- Options will be dynamically loaded based on the main demographic selection -->
        </select>

        <!-- Container for Selecting QOL Data Type -->
        <div id="qol_data_type_container">
            <label for="qol_data_type">Select QOL Data Type:</label>
            <select name="qol_data_type" id="qol_data_type">
                <option value="">Select a QOL data type</option>
                <!-- Options will be dynamically loaded -->
            </select>
        </div>

        <button type="submit">Visualize</button>
    </form>

    <div id="qol-results">
        <!-- Queried data will be displayed here -->
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#data_type').change(function() {
                var selectedType = $(this).val();
                if (selectedType === 'qol') {
                    $('#qol_data_type_container').show();
                } else {
                    $('#qol_data_type_container').hide();
                    $('#qol_data_type').empty().append('<option value="">Select a QOL data type</option>');
                }
            });

            $('#demographic').change(function(){
                var selectedDemographic = $(this).val();
                // Log the selected demographic
                console.log("Selected Demographic: " + selectedDemographic);
    
                $.ajax({
                    url: '{% url "demographics" %}',
                    data: {
                        'demographic': selectedDemographic
                    },
                    dataType: 'json',
                    success: function (data) {
                        var specificDemographicSelect = $('#specific_demographic');
                        specificDemographicSelect.empty();
                        specificDemographicSelect.append('<option value=""></option>');
                        $.each(data.specific_options, function(index, value) {
                            specificDemographicSelect.append($('<option>', {
                                value: value, // Use value as the option value
                                text: value  // Use value as the option text
                            }));
                        });
                    }
                });
            });
    
            // When specific demographic changes
            $('#specific_demographic').change(function(){
                var selectedTown = $('#town').val();
                var selectedDemographic = $(this).val();
                // Log the selected specific demographic
                console.log("Town: " + selectedTown + ", Specific Demographic: " + selectedDemographic);
    
                var qolDataTypeSelect = $('#qol_data_type');
                qolDataTypeSelect.empty();
    
                var qolDataTypeSelect = $('#qol_data_type');
                qolDataTypeSelect.empty();
                qolDataTypeSelect.append('<option value="" selected></option>');
                if (selectedDemographic) {
                    // Simulated QOL data types
                    var qolOptions = {
                        'Jobs': 'Jobs',
                        'Medical': 'Medical',
                        'shop': 'Shopping Options',
                        'k12': 'Public School',
                        'Housing': 'Housing',
                        'Childcare': 'Childcare',
                        'Seniorcare': 'Seniorcare',
                        'Youth': 'Youth Programs',
                        'commsrvall': 'Community Services Overall',
                        'recrentr': 'Recreation and Entertainment',
                        'Police': 'Police',
                        'Fire': 'Fire',
                        'ems': 'Emergency Medical Services',
                        'Streets': 'Condition of Streets',
                        'Parks': 'Condition of Parks',
                        'Garbage': 'Garbage Collection',
                        'Water': 'Water',
                        'govtsrvall': 'Government Services Overall'
                    };

                    $.each(qolOptions, function(key, label) {
                        qolDataTypeSelect.append($('<option>', {
                            value: key,
                            text: label
                        }));
                    });
                } else {
                    qolDataTypeSelect.append($('<option>', {
                        value: '',
                        text: 'Please select a specific demographic'
                    }));
                }
    
            });
    
            // When QOL data type changes
            $('#qol_data_type').change(function(){
                var selectedQOLDataType = $(this).val();
                // Log the selected QOL data type
                console.log("Selected QOL Data Type: " + selectedQOLDataType);
            });

            $('#selection-form').on('submit', function(event) {
                event.preventDefault();

                var formData = {
                    'town': $('#town').val(),
                    'demographic': $('#demographic').val(),
                    'specific_demographic': $('#specific_demographic').val(),
                    'data_type': $('#data_type').val()
                };

                if (formData.data_type === 'qol') {
                    formData['qol_data_type'] = $('#qol_data_type').val();
                }

                $.ajax({
                    url: "{% url 'query_data' %}",
                    method: 'GET',
                    data: formData,
                    success: function(response) {
                        console.log(response);
                        $('#qol-results').empty();
                        if (response.qol_ratings) {
                            for (const [key, value] of Object.entries(response.qol_ratings)) {
                                $('#qol-results').append(`<p>${key}: ${value}</p>`);
                            }
                        } else if (response.error) {
                            $('#qol-results').append(`<p>Error: ${response.error}</p>`);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error: " + error);
                    }
                });
            });
        });
    </script>
</body>
</html>
